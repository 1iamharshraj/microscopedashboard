{% extends "base.html" %}

{% block title %}Analytics - Microbe Insights{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        transition: all 0.3s;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
    }
    
    .chart-container.large {
        height: 400px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .trend-indicator {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    .trend-up {
        color: #28a745;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    .trend-neutral {
        color: #6c757d;
    }
    
    .filter-tabs {
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 2rem;
    }
    
    .filter-tab {
        padding: 0.75rem 1.5rem;
        border: none;
        background: none;
        color: #6c757d;
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
    }
    
    .filter-tab.active {
        color: #007bff;
        border-bottom-color: #007bff;
    }
    
    .filter-tab:hover {
        color: #007bff;
    }
    
    .export-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .species-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .species-item:last-child {
        border-bottom: none;
    }
    
    .species-bar {
        width: 100px;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .species-fill {
        height: 100%;
        background: #007bff;
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<!-- Filter Tabs -->
<div class="filter-tabs">
    <div class="d-flex">
        <button class="filter-tab active" data-period="7d" onclick="changePeriod('7d')">
            <i class="fas fa-calendar-week me-2"></i>
            Last 7 Days
        </button>
        <button class="filter-tab" data-period="30d" onclick="changePeriod('30d')">
            <i class="fas fa-calendar-alt me-2"></i>
            Last 30 Days
        </button>
        <button class="filter-tab" data-period="90d" onclick="changePeriod('90d')">
            <i class="fas fa-calendar me-2"></i>
            Last 90 Days
        </button>
        <button class="filter-tab" data-period="all" onclick="changePeriod('all')">
            <i class="fas fa-chart-line me-2"></i>
            All Time
        </button>
    </div>
</div>

<!-- Key Metrics -->
<div class="stats-grid">
    <div class="card metric-card">
        <div class="card-body text-center">
            <div class="metric-value" id="totalReports">0</div>
            <div class="metric-label">Total Analyses</div>
            <div class="trend-indicator">
                <i class="fas fa-arrow-up trend-up me-1"></i>
                <span class="trend-up">+12% from last period</span>
            </div>
        </div>
    </div>
    
    <div class="card metric-card">
        <div class="card-body text-center">
            <div class="metric-value" id="detectionRate">0%</div>
            <div class="metric-label">Detection Rate</div>
            <div class="trend-indicator">
                <i class="fas fa-arrow-up trend-up me-1"></i>
                <span class="trend-up">+5.2% from last period</span>
            </div>
        </div>
    </div>
    
    <div class="card metric-card">
        <div class="card-body text-center">
            <div class="metric-value" id="avgProcessingTime">0s</div>
            <div class="metric-label">Avg Processing Time</div>
            <div class="trend-indicator">
                <i class="fas fa-arrow-down trend-down me-1"></i>
                <span class="trend-down">-0.3s from last period</span>
            </div>
        </div>
    </div>
    
    <div class="card metric-card">
        <div class="card-body text-center">
            <div class="metric-value" id="storageUsage">0 GB</div>
            <div class="metric-label">Storage Used</div>
            <div class="trend-indicator">
                <i class="fas fa-arrow-up trend-neutral me-1"></i>
                <span class="trend-neutral">+2.1 GB from last period</span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Charts Section -->
    <div class="col-lg-8">
        <!-- Detection Trends Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Detection Trends
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Microplastic Types Distribution -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Microplastic Types Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="microplasticPieChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="microplasticBarChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Plankton Species Distribution -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Plankton Species Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container large">
                    <canvas id="planktonChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Processing Performance -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Processing Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Top Species -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    Top Plankton Species
                </h6>
            </div>
            <div class="card-body">
                <div id="topSpecies">
                    <!-- Species will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Confidence Distribution -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Confidence Distribution
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="confidenceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Recent Activity
                </h6>
            </div>
            <div class="card-body">
                <div id="recentActivity">
                    <!-- Activity will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="exportAnalytics()">
                        <i class="fas fa-download me-2"></i>
                        Export Analytics
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="generateReport()">
                        <i class="fas fa-file-alt me-2"></i>
                        Generate Report
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="scheduleBackup()">
                        <i class="fas fa-cloud-upload-alt me-2"></i>
                        Schedule Backup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Section -->
<div class="export-section">
    <h5 class="mb-3">
        <i class="fas fa-download me-2"></i>
        Export Analytics Data
    </h5>
    <div class="row">
        <div class="col-md-3">
            <button class="btn btn-outline-primary w-100" onclick="exportData('csv')">
                <i class="fas fa-file-csv me-2"></i>
                Export as CSV
            </button>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-danger w-100" onclick="exportData('pdf')">
                <i class="fas fa-file-pdf me-2"></i>
                Export as PDF
            </button>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-success w-100" onclick="exportData('excel')">
                <i class="fas fa-file-excel me-2"></i>
                Export as Excel
            </button>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-info w-100" onclick="exportData('json')">
                <i class="fas fa-file-code me-2"></i>
                Export as JSON
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPeriod = '7d';
let charts = {};

// Initialize analytics
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
    initializeCharts();
});

function changePeriod(period) {
    currentPeriod = period;
    
    // Update active tab
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-period="${period}"]`).classList.add('active');
    
    // Reload data
    loadAnalyticsData();
}

function loadAnalyticsData() {
    fetch('/analytics/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMetrics(data.stats);
                updateCharts(data.stats);
                updateSidebar(data.stats);
            }
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
        });
}

function updateMetrics(stats) {
    document.getElementById('totalReports').textContent = stats.total_reports || 0;
    document.getElementById('detectionRate').textContent = (stats.detection_rate || 0).toFixed(1) + '%';
    document.getElementById('avgProcessingTime').textContent = (stats.avg_processing_time || 0).toFixed(1) + 's';
    document.getElementById('storageUsage').textContent = (stats.storage_usage || 0).toFixed(1) + ' GB';
}

function initializeCharts() {
    // Trends Chart
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    charts.trends = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Total Analyses',
                data: [],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }, {
                label: 'Microplastic Detections',
                data: [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Microplastic Pie Chart
    const pieCtx = document.getElementById('microplasticPieChart').getContext('2d');
    charts.microplasticPie = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['Fibers', 'Fragments', 'Pellets', 'Films'],
            datasets: [{
                data: [45, 30, 15, 10],
                backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Microplastic Bar Chart
    const barCtx = document.getElementById('microplasticBarChart').getContext('2d');
    charts.microplasticBar = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['Fibers', 'Fragments', 'Pellets', 'Films'],
            datasets: [{
                label: 'Count',
                data: [120, 80, 40, 25],
                backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Plankton Chart
    const planktonCtx = document.getElementById('planktonChart').getContext('2d');
    charts.plankton = new Chart(planktonCtx, {
        type: 'bar',
        data: {
            labels: ['Diatoms', 'Copepods', 'Dinoflagellates', 'Radiolarians', 'Foraminifera'],
            datasets: [{
                label: 'Count',
                data: [150, 120, 80, 45, 30],
                backgroundColor: '#17a2b8'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Performance Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    charts.performance = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Processing Time (s)',
                data: [],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Confidence Chart
    const confidenceCtx = document.getElementById('confidenceChart').getContext('2d');
    charts.confidence = new Chart(confidenceCtx, {
        type: 'doughnut',
        data: {
            labels: ['High (90-100%)', 'Medium (70-89%)', 'Low (50-69%)', 'Very Low (<50%)'],
            datasets: [{
                data: [35, 40, 20, 5],
                backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function updateCharts(stats) {
    // Update trends chart
    if (stats.daily_trends && charts.trends) {
        charts.trends.data.labels = stats.daily_trends.map(t => t.date);
        charts.trends.data.datasets[0].data = stats.daily_trends.map(t => t.total);
        charts.trends.data.datasets[1].data = stats.daily_trends.map(t => t.detections);
        charts.trends.update();
    }
    
    // Update microplastic charts
    if (stats.microplastic_distribution && charts.microplasticPie) {
        const dist = stats.microplastic_distribution;
        charts.microplasticPie.data.datasets[0].data = [
            dist.fiber || 0,
            dist.fragment || 0,
            dist.pellet || 0,
            dist.film || 0
        ];
        charts.microplasticPie.update();
        
        charts.microplasticBar.data.datasets[0].data = [
            dist.fiber || 0,
            dist.fragment || 0,
            dist.pellet || 0,
            dist.film || 0
        ];
        charts.microplasticBar.update();
    }
    
    // Update plankton chart
    if (stats.species_distribution && charts.plankton) {
        const species = Object.keys(stats.species_distribution);
        const counts = Object.values(stats.species_distribution);
        
        charts.plankton.data.labels = species;
        charts.plankton.data.datasets[0].data = counts;
        charts.plankton.update();
    }
}

function updateSidebar(stats) {
    // Update top species
    if (stats.species_distribution) {
        const topSpeciesDiv = document.getElementById('topSpecies');
        const sortedSpecies = Object.entries(stats.species_distribution)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        topSpeciesDiv.innerHTML = sortedSpecies.map(([species, count], index) => `
            <div class="species-item">
                <div>
                    <div class="fw-bold">${index + 1}. ${species}</div>
                    <small class="text-muted">${count} individuals</small>
                </div>
                <div class="species-bar">
                    <div class="species-fill" style="width: ${(count / sortedSpecies[0][1]) * 100}%"></div>
                </div>
            </div>
        `).join('');
    }
    
    // Update recent activity
    const recentActivityDiv = document.getElementById('recentActivity');
    recentActivityDiv.innerHTML = `
        <div class="species-item">
            <div>
                <div class="small fw-bold">Sample Analysis</div>
                <small class="text-muted">2 minutes ago</small>
            </div>
            <i class="fas fa-vial text-primary"></i>
        </div>
        <div class="species-item">
            <div>
                <div class="small fw-bold">Data Export</div>
                <small class="text-muted">15 minutes ago</small>
            </div>
            <i class="fas fa-download text-success"></i>
        </div>
        <div class="species-item">
            <div>
                <div class="small fw-bold">Report Generated</div>
                <small class="text-muted">1 hour ago</small>
            </div>
            <i class="fas fa-file-alt text-info"></i>
        </div>
    `;
}

function exportAnalytics() {
    // Implementation for exporting analytics
    alert('Analytics export functionality would be implemented here');
}

function exportData(format) {
    // Implementation for exporting data in different formats
    alert(`Exporting data as ${format.toUpperCase()}...`);
}

function generateReport() {
    // Implementation for generating reports
    alert('Report generation functionality would be implemented here');
}

function scheduleBackup() {
    // Implementation for scheduling backups
    alert('Backup scheduling functionality would be implemented here');
}

// Auto-refresh analytics every 5 minutes
setInterval(loadAnalyticsData, 300000);
</script>
{% endblock %}
