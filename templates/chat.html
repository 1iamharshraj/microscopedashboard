{% extends "base.html" %}

{% block title %}AI Lab - Microbe Insights{% endblock %}
{% block page_title %}AI Lab{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #f8f9fa;
        margin-bottom: 1rem;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.assistant {
        justify-content: flex-start;
    }
    
    .message-content {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        position: relative;
    }
    
    .message.user .message-content {
        background: #007bff;
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.assistant .message-content {
        background: white;
        color: #333;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 4px;
    }
    
    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        margin: 0 0.5rem;
        flex-shrink: 0;
    }
    
    .message.user .message-avatar {
        background: #007bff;
        color: white;
        order: 2;
    }
    
    .message.assistant .message-avatar {
        background: #6c757d;
        color: white;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
        text-align: right;
    }
    
    .message.assistant .message-time {
        text-align: left;
    }
    
    .chat-input-area {
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
    }
    
    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        margin-bottom: 1rem;
    }
    
    .file-upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .file-upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
    
    .typing-indicator {
        display: none;
        align-items: center;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        margin-bottom: 1rem;
        max-width: 70%;
    }
    
    .typing-indicator.show {
        display: flex;
    }
    
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #6c757d;
        animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }
    
    .quick-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .quick-action-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 20px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .quick-action-btn:hover {
        background: #f8f9fa;
        border-color: #007bff;
    }
    
    .uploaded-file {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        background: #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    
    .uploaded-file .file-icon {
        margin-right: 0.5rem;
        color: #6c757d;
    }
    
    .uploaded-file .file-info {
        flex: 1;
    }
    
    .uploaded-file .file-remove {
        color: #dc3545;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    AI Assistant
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div>Hello! I'm your AI assistant for microscopy analysis. I can help you with:</div>
                                <ul class="mb-0 mt-2">
                                    <li>Understanding microplastic detection results</li>
                                    <li>Interpreting plankton classification data</li>
                                    <li>Providing analysis guidance</li>
                                    <li>Answering questions about your samples</li>
                                </ul>
                                <div class="message-time">Just now</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    
                    <div class="chat-input-area">
                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <div class="quick-action-btn" onclick="sendQuickMessage('Tell me about microplastic detection')">
                                <i class="fas fa-vial me-1"></i>
                                Microplastic Help
                            </div>
                            <div class="quick-action-btn" onclick="sendQuickMessage('Explain plankton classification')">
                                <i class="fas fa-fish me-1"></i>
                                Plankton Guide
                            </div>
                            <div class="quick-action-btn" onclick="sendQuickMessage('How do I improve my analysis results?')">
                                <i class="fas fa-lightbulb me-1"></i>
                                Analysis Tips
                            </div>
                            <div class="quick-action-btn" onclick="sendQuickMessage('What are the latest trends in microscopy?')">
                                <i class="fas fa-chart-line me-1"></i>
                                Latest Trends
                            </div>
                        </div>
                        
                        <!-- File Upload Area -->
                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <div class="text-muted">
                                <strong>Upload files for analysis</strong><br>
                                <small>Drag & drop files here or click to select</small>
                            </div>
                            <input type="file" id="fileInput" multiple accept="image/*,.pdf,.txt,.csv" style="display: none;">
                        </div>
                        
                        <!-- Uploaded Files -->
                        <div id="uploadedFiles"></div>
                        
                        <!-- Chat Input -->
                        <div class="input-group">
                            <input type="text" class="form-control" id="messageInput" placeholder="Ask me anything about your microscopy analysis..." onkeypress="handleKeyPress(event)">
                            <button class="btn btn-primary" type="button" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- AI Capabilities -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-brain me-2"></i>
                    AI Capabilities
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6><i class="fas fa-vial text-primary me-2"></i>Microplastic Analysis</h6>
                    <ul class="small text-muted mb-0">
                        <li>Detection pattern interpretation</li>
                        <li>Particle classification guidance</li>
                        <li>Quality assessment tips</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-fish text-info me-2"></i>Plankton Classification</h6>
                    <ul class="small text-muted mb-0">
                        <li>Species identification help</li>
                        <li>Ecological context</li>
                        <li>Taxonomic guidance</li>
                    </ul>
                </div>
                <div>
                    <h6><i class="fas fa-chart-line text-success me-2"></i>Data Analysis</h6>
                    <ul class="small text-muted mb-0">
                        <li>Statistical interpretation</li>
                        <li>Trend analysis</li>
                        <li>Report generation</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Recent Conversations -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Topics
                </h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-vial text-primary me-2"></i>
                            <div>
                                <div class="small fw-bold">Microplastic Detection</div>
                                <small class="text-muted">2 minutes ago</small>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-fish text-info me-2"></i>
                            <div>
                                <div class="small fw-bold">Plankton Species</div>
                                <small class="text-muted">5 minutes ago</small>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            <div>
                                <div class="small fw-bold">Analysis Tips</div>
                                <small class="text-muted">10 minutes ago</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help Resources -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-book me-2"></i>
                    Help Resources
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('help.help') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-question-circle me-2"></i>
                        Documentation
                    </a>
                    <a href="{{ url_for('capture.capture') }}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-camera me-2"></i>
                        Start Analysis
                    </a>
                    <a href="{{ url_for('analytics.analytics') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-chart-bar me-2"></i>
                        View Analytics
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let uploadedFiles = [];

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    // Set up file upload
    setupFileUpload();
    
    // Focus on message input
    document.getElementById('messageInput').focus();
});

function setupFileUpload() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    
    fileUploadArea.addEventListener('click', () => fileInput.click());
    
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });
    
    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragover');
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
}

function handleFiles(files) {
    Array.from(files).forEach(file => {
        uploadFile(file);
    });
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/chat_api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            uploadedFiles.push({
                name: file.name,
                filename: data.filename,
                size: file.size,
                type: file.type
            });
            displayUploadedFile(data.filename, file.name, file.size);
        } else {
            alert('Failed to upload file: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('Failed to upload file: ' + error.message);
    });
}

function displayUploadedFile(filename, name, size) {
    const uploadedFilesDiv = document.getElementById('uploadedFiles');
    const fileDiv = document.createElement('div');
    fileDiv.className = 'uploaded-file';
    fileDiv.innerHTML = `
        <i class="fas fa-file file-icon"></i>
        <div class="file-info">
            <div class="small fw-bold">${name}</div>
            <small class="text-muted">${formatFileSize(size)}</small>
        </div>
        <i class="fas fa-times file-remove" onclick="removeFile('${filename}')"></i>
    `;
    uploadedFilesDiv.appendChild(fileDiv);
}

function removeFile(filename) {
    uploadedFiles = uploadedFiles.filter(file => file.filename !== filename);
    // Remove from DOM
    event.target.closest('.uploaded-file').remove();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage('user', message);
    
    // Clear input
    messageInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to AI
    fetch('/chat_api', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            files: uploadedFiles.map(f => f.filename)
        })
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator();
        
        if (data.success) {
            addMessage('assistant', data.response);
        } else {
            addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
        }
    })
    .catch(error => {
        hideTypingIndicator();
        addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
        console.error('Chat error:', error);
    });
}

function sendQuickMessage(message) {
    document.getElementById('messageInput').value = message;
    sendMessage();
}

function addMessage(sender, content) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatar = sender === 'user' ? 
        '<i class="fas fa-user"></i>' : 
        '<i class="fas fa-robot"></i>';
    
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${avatar}
        </div>
        <div class="message-content">
            <div>${content}</div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').classList.add('show');
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').classList.remove('show');
}
</script>
{% endblock %}
